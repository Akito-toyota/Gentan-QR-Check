<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>åŸå QR ç…§åˆ</title>

  <!-- QRèª­ã¿å–ã‚Š -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <!-- Excel(xlsx)èª­ã¿å–ã‚Š -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: #f5f7fb;
      padding: 20px;
    }

    h2 {
      color: #333;
    }

    input[type="file"] {
      background: white;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      max-width: 700px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-top: 10px;
    }

    th {
      background: #4f6df5;
      color: white;
      font-weight: 600;
      padding: 10px;
    }

    td {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .pending {
      background: #fafafa;
    }

    .done {
      background: #e6f8ea;
      color: #1b7f3b;
      font-weight: 600;
    }

    #qrText {
      font-weight: 600;
      color: #333;
    }

    #message {
      margin-top: 12px;
      font-size: 18px;
      font-weight: 600;
    }

    #reader {
      margin-top: 15px;
      padding: 10px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      width: 320px;
    }
  </style>
</head>
<body>

<h2>åŸå QR ç…§åˆ</h2>

<input type="file" id="excelFile" accept=".xlsx,.xlsm"><br><br>

<table>
  <thead>
    <tr>
      <th>ç•ªå·</th>
      <th>å†…å®¹</th>
      <th>çŠ¶æ…‹</th>
    </tr>
  </thead>
  <tbody id="list"></tbody>
</table>

<p>èª­ã¿å–ã£ãŸQRï¼š<span id="qrText">æœªèª­è¾¼</span></p>
<div id="message"></div>

<div id="reader"></div>

<script>
let rows = [];            // { a, b, done }
let scanned = new Set(); // äºŒåº¦èª­ã¿é˜²æ­¢

const tbody = document.getElementById("list");
const messageEl = document.getElementById("message");

// Excelèª­ã¿è¾¼ã¿ï¼ˆAåˆ—ãƒ»Båˆ—ï¼‰
document.getElementById("excelFile").addEventListener("change", e => {
  const reader = new FileReader();
  reader.onload = ev => {
    const wb = XLSX.read(new Uint8Array(ev.target.result), { type: "array" });
    const sheet = wb.Sheets["QRã‚³ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ"];
    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    rows = data
      .filter(r => r[0] && r[1])
      .map(r => ({
        a: r[0],
        b: r[1],
        done: false
      }));

    scanned.clear();
    messageEl.textContent = "";
    render();
  };
  reader.readAsArrayBuffer(e.target.files[0]);
});

// è¡¨ç¤ºæ›´æ–°
function render() {
  tbody.innerHTML = "";
  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.className = r.done ? "done" : "pending";
    tr.innerHTML = `
      <td>${r.a}</td>
      <td>${r.b}</td>
      <td>${r.done ? "âœ… å®Œäº†" : "â³ æœªå–å¾—"}</td>
    `;
    tbody.appendChild(tr);
  });

  if (rows.length > 0 && rows.every(r => r.done)) {
    messageEl.textContent = "ğŸ‰ å…¨ã¦ã®åŸåç…§åˆãŒå®Œäº†ã—ã¾ã—ãŸ";
    messageEl.style.color = "green";
  }
}

// QRèª­ã¿å–ã‚Š
const qr = new Html5Qrcode("reader");
qr.start(
  { facingMode: "environment" },
  { fps: 10 },
  text => {
    document.getElementById("qrText").textContent = text;

    // äºŒåº¦èª­ã¿é˜²æ­¢
    if (scanned.has(text)) return;

    const hit = rows.find(r => r.b === text && !r.done);

    if (hit) {
      hit.done = true;
      scanned.add(text);
      messageEl.textContent = "";
      render();
    } else {
      messageEl.textContent = "âŒ ä¸€è‡´ã—ã¾ã›ã‚“";
      messageEl.style.color = "red";
    }
  }
);
</script>

</body>
</html>